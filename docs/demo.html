<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Customer Admin ‚Äî Demo Preview</title>
  <style>/* === Reset & Base === */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0f1117;
  --bg-card: #1a1d27;
  --bg-input: #252836;
  --bg-hover: #2a2d3a;
  --text: #e4e4e7;
  --text-muted: #8b8d97;
  --text-dim: #5c5e69;
  --accent: #6366f1;
  --accent-hover: #818cf8;
  --danger: #ef4444;
  --danger-hover: #f87171;
  --success: #22c55e;
  --warning: #f59e0b;
  --border: #2e3142;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --transition: 0.2s ease;
}

html, body {
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  overflow: hidden;
}

#app {
  height: 100%;
  position: relative;
}

/* === Screens === */
.screen {
  display: none;
  height: 100%;
  flex-direction: column;
  overflow: hidden;
}
.screen.active {
  display: flex;
}

/* === Auth Screen === */
.auth-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
  height: 100%;
  max-width: 400px;
  margin: 0 auto;
  gap: 16px;
}
.logo { font-size: 64px; margin-bottom: 8px; }
.auth-container h1 { font-size: 24px; font-weight: 700; }
.subtitle { color: var(--text-muted); font-size: 14px; margin-bottom: 8px; }
.error-text { color: var(--danger); font-size: 13px; min-height: 20px; }

/* === Top Bar === */
.topbar {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  gap: 12px;
  flex-shrink: 0;
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 10;
}
.topbar h1 {
  flex: 1;
  font-size: 18px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.topbar-actions {
  display: flex;
  gap: 8px;
}

/* === Stats Bar === */
.stats-bar {
  display: flex;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  overflow-x: auto;
}
.stat-chip {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: var(--bg-card);
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
}
.stat-chip .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.dot-active { background: var(--success); }
.dot-paused { background: var(--warning); }
.dot-total { background: var(--accent); }

/* === Customer List === */
.customer-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px 0;
  -webkit-overflow-scrolling: touch;
}

.customer-card {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  gap: 12px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background var(--transition);
  -webkit-tap-highlight-color: transparent;
}
.customer-card:hover { background: var(--bg-hover); }
.customer-card:active { background: var(--bg-input); }

.card-status {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.status-active { background: var(--success); }
.status-paused { background: var(--warning); }
.status-inactive { background: var(--text-dim); }

.card-info { flex: 1; min-width: 0; }
.card-name {
  font-size: 15px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.card-meta {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-badges {
  display: flex;
  gap: 6px;
  flex-shrink: 0;
}
.badge {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 3px 8px;
  border-radius: 4px;
  white-space: nowrap;
}
.badge-paid { background: rgba(99,102,241,0.15); color: var(--accent); }
.badge-free { background: rgba(139,141,151,0.15); color: var(--text-muted); }

.card-arrow {
  color: var(--text-dim);
  font-size: 18px;
  flex-shrink: 0;
}

/* === Empty State === */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px;
  text-align: center;
}
.empty-icon { font-size: 48px; margin-bottom: 16px; }
.empty-state h2 { font-size: 18px; margin-bottom: 8px; }
.empty-state p { color: var(--text-muted); font-size: 14px; }

/* === FAB === */
.fab {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 16px;
  background: var(--accent);
  color: white;
  font-size: 28px;
  font-weight: 300;
  border: none;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: all var(--transition);
  z-index: 20;
  display: flex;
  align-items: center;
  justify-content: center;
}
.fab:hover { background: var(--accent-hover); transform: scale(1.05); }
.fab:active { transform: scale(0.95); }

/* === Detail Screen === */
.detail-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px 16px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  -webkit-overflow-scrolling: touch;
}

/* === Forms === */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
  width: 100%;
}
.form-group label {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
}
input, textarea {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px;
  font-size: 15px;
  color: var(--text);
  font-family: inherit;
  outline: none;
  transition: border-color var(--transition);
  width: 100%;
}
input:focus, textarea:focus {
  border-color: var(--accent);
}
textarea {
  resize: vertical;
  min-height: 120px;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 13px;
  line-height: 1.5;
}

/* === Toggle Row === */
.toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 4px 0;
}
.toggle-row label {
  font-size: 14px;
  font-weight: 500;
}
.toggle-group {
  display: flex;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  overflow: hidden;
  border: 1px solid var(--border);
}

/* === Buttons === */
.btn {
  border: none;
  cursor: pointer;
  font-family: inherit;
  font-weight: 500;
  transition: all var(--transition);
  -webkit-tap-highlight-color: transparent;
}
.btn-primary {
  background: var(--accent);
  color: white;
  padding: 14px 24px;
  border-radius: var(--radius-sm);
  font-size: 15px;
}
.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:active { transform: scale(0.98); }

.btn-secondary {
  background: var(--bg-input);
  color: var(--text);
  padding: 12px 24px;
  border-radius: var(--radius-sm);
  font-size: 14px;
}
.btn-secondary:hover { background: var(--bg-hover); }

.btn-danger {
  background: var(--danger);
  color: white;
  padding: 12px 24px;
  border-radius: var(--radius-sm);
  font-size: 14px;
}
.btn-danger:hover { background: var(--danger-hover); }

.btn-icon {
  background: none;
  color: var(--text-muted);
  font-size: 20px;
  padding: 4px 8px;
  border-radius: var(--radius-sm);
}
.btn-icon:hover { color: var(--text); background: var(--bg-hover); }
.btn-icon.btn-danger { background: none; color: var(--danger); }
.btn-icon.btn-danger:hover { background: rgba(239,68,68,0.1); }

.btn-sm {
  padding: 8px 16px;
  font-size: 13px;
}
.btn-toggle {
  background: transparent;
  color: var(--text-muted);
  border-radius: 0;
}
.btn-toggle.active {
  background: var(--accent);
  color: white;
}

.btn-full { width: 100%; }

.action-buttons {
  padding-top: 8px;
}

/* === Dialog === */
.dialog-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  padding: 24px;
  backdrop-filter: blur(4px);
}
.dialog {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 24px;
  max-width: 340px;
  width: 100%;
  box-shadow: var(--shadow);
}
.dialog h3 { font-size: 17px; margin-bottom: 8px; }
.dialog p { color: var(--text-muted); font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
.dialog-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* === Toast === */
.toast {
  position: fixed;
  bottom: 96px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 12px 24px;
  border-radius: var(--radius);
  font-size: 14px;
  box-shadow: var(--shadow);
  z-index: 200;
  transition: opacity 0.3s ease, transform 0.3s ease;
  white-space: nowrap;
}
.toast.hidden {
  opacity: 0;
  transform: translateX(-50%) translateY(12px);
  pointer-events: none;
}

/* === Tool Deny Grid === */
.tool-deny-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text);
  cursor: pointer;
  padding: 8px 10px;
  background: var(--bg-input);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  transition: all var(--transition);
}
.checkbox-label:hover { border-color: var(--accent); }
.checkbox-label input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: var(--accent);
  cursor: pointer;
}
.checkbox-label code {
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 12px;
  color: var(--accent);
  background: rgba(99,102,241,0.1);
  padding: 1px 5px;
  border-radius: 3px;
}

/* === Utilities === */
.hidden { display: none !important; }

/* === Loading Spinner === */
.spinner {
  display: inline-block;
  width: 18px;
  height: 18px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* === Responsive === */
@media (min-width: 600px) {
  .customer-list { max-width: 600px; margin: 0 auto; width: 100%; }
  .detail-body { max-width: 600px; margin: 0 auto; width: 100%; }
  .stats-bar { max-width: 600px; margin: 0 auto; width: 100%; }
}
</style>
</head>
<body>
  <div id="app">
    <!-- Auth Screen -->
    <div id="auth-screen" class="screen">
      <div class="auth-container">
        <div class="logo">ü§ñ</div>
        <h1>Customer Admin</h1>
        <p class="subtitle">Manage your bot's customer channels</p>
        <div class="form-group">
          <label for="api-url">API URL</label>
          <input type="url" id="api-url" placeholder="http://localhost:3002" value="http://localhost:3002">
        </div>
        <div class="form-group">
          <label for="api-token">API Token</label>
          <input type="password" id="api-token" placeholder="Bearer token">
        </div>
        <button class="btn btn-primary btn-full" onclick="App.connect()">Connect</button>
        <p id="auth-error" class="error-text"></p>
      </div>
    </div>

    <!-- Customer List Screen -->
    <div id="list-screen" class="screen active">
      <header class="topbar">
        <h1>Customers</h1>
        <div class="topbar-actions">
          <button class="btn btn-icon" onclick="App.refresh()" title="Refresh">‚Üª</button>
          <button class="btn btn-icon" onclick="App.logout()" title="Disconnect">‚èª</button>
        </div>
      </header>

      <div class="stats-bar" id="stats-bar"></div>

      <div id="customer-list" class="customer-list">
        <!-- Populated by JS -->
      </div>

      <div id="empty-state" class="empty-state hidden">
        <div class="empty-icon">üì≠</div>
        <h2>No customers yet</h2>
        <p>Add your first customer channel to get started.</p>
      </div>

      <button class="fab" onclick="App.showAdd()" title="Add Customer">+</button>
    </div>

    <!-- Customer Detail / Edit Screen -->
    <div id="detail-screen" class="screen">
      <header class="topbar">
        <button class="btn btn-icon" onclick="App.backToList()">‚Üê</button>
        <h1 id="detail-title">Customer</h1>
        <div class="topbar-actions">
          <button class="btn btn-icon btn-danger" onclick="App.confirmDelete()" title="Delete">üóë</button>
        </div>
      </header>

      <div class="detail-body">
        <div class="form-group">
          <label for="cust-name">Channel Name</label>
          <input type="text" id="cust-name" placeholder="#client-acme">
        </div>

        <div class="form-group">
          <label for="cust-prompt">System Prompt</label>
          <textarea id="cust-prompt" rows="8" placeholder="You are a helpful assistant for Acme Corp..."></textarea>
        </div>

        <div class="form-group">
          <label for="cust-tools">Tools (comma-separated)</label>
          <input type="text" id="cust-tools" placeholder="web_search, calculator">
        </div>

        <div class="toggle-row">
          <label>Status</label>
          <div class="toggle-group">
            <button id="toggle-active" class="btn btn-sm btn-toggle active" onclick="App.setStatus(true)">Active</button>
            <button id="toggle-paused" class="btn btn-sm btn-toggle" onclick="App.setStatus(false)">Paused</button>
          </div>
        </div>

        <div class="form-group">
          <label for="cust-users">Allowed Slack Users (one per line)</label>
          <textarea id="cust-users" rows="4" placeholder="U01ABC123&#10;U02DEF456&#10;U03GHI789"></textarea>
        </div>

        <div class="form-group">
          <label>Tool Restrictions</label>
          <div class="tool-deny-grid" id="tool-deny-grid">
            <label class="checkbox-label"><input type="checkbox" data-tool="exec" checked> Block <code>exec</code></label>
            <label class="checkbox-label"><input type="checkbox" data-tool="write" checked> Block <code>write</code></label>
            <label class="checkbox-label"><input type="checkbox" data-tool="edit" checked> Block <code>edit</code></label>
            <label class="checkbox-label"><input type="checkbox" data-tool="gateway"> Block <code>gateway</code></label>
            <label class="checkbox-label"><input type="checkbox" data-tool="message"> Block <code>message</code></label>
            <label class="checkbox-label"><input type="checkbox" data-tool="cron"> Block <code>cron</code></label>
          </div>
        </div>

        <div class="toggle-row">
          <label>Paid Access</label>
          <div class="toggle-group">
            <button id="toggle-paid" class="btn btn-sm btn-toggle" onclick="App.setPaid(true)">Paid</button>
            <button id="toggle-free" class="btn btn-sm btn-toggle active" onclick="App.setPaid(false)">Free</button>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary btn-full" onclick="App.saveCustomer()">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirm-dialog" class="dialog-overlay hidden">
      <div class="dialog">
        <h3 id="confirm-title">Confirm</h3>
        <p id="confirm-message">Are you sure?</p>
        <div class="dialog-actions">
          <button class="btn btn-secondary" onclick="App.dismissDialog()">Cancel</button>
          <button class="btn btn-danger" id="confirm-action" onclick="App.executeConfirmed()">Delete</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden"></div>
  </div>

  <script>// Customer Admin Dashboard ‚Äî Standalone Frontend
// Connects to the customer-admin Express API

const App = (() => {
  let apiUrl = '';
  let apiToken = '';
  let customers = [];
  let currentCustomer = null; // null = new, object = editing
  let isNew = false;
  let editStatus = true;
  let editPaid = false;
  let pendingAction = null;

  // --- Storage ---
  function saveAuth() {
    localStorage.setItem('ca_api_url', apiUrl);
    localStorage.setItem('ca_api_token', apiToken);
  }
  function loadAuth() {
    const url = localStorage.getItem('ca_api_url');
    const token = localStorage.getItem('ca_api_token');
    if (url && token) {
      document.getElementById('api-url').value = url;
      document.getElementById('api-token').value = token;
    }
  }

  // --- API ---
  async function api(method, path, body) {
    const opts = {
      method,
      headers: {
        'Authorization': `Bearer ${apiToken}`,
        'Content-Type': 'application/json',
      },
    };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(`${apiUrl}${path}`, opts);
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`${res.status}: ${text}`);
    }
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('json')) return res.json();
    return null;
  }

  // --- Screens ---
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // --- Connect ---
  async function connect() {
    apiUrl = document.getElementById('api-url').value.replace(/\/+$/, '');
    apiToken = document.getElementById('api-token').value.trim();

    if (!apiUrl || !apiToken) {
      document.getElementById('auth-error').textContent = 'Both fields are required.';
      return;
    }

    document.getElementById('auth-error').textContent = '';

    try {
      await api('GET', '/api/health');
      saveAuth();
      await loadCustomers();
      showScreen('list-screen');
    } catch (e) {
      document.getElementById('auth-error').textContent = `Connection failed: ${e.message}`;
    }
  }

  // --- Load Customers ---
  async function loadCustomers() {
    try {
      const data = await api('GET', '/api/customers');
      customers = Array.isArray(data) ? data : (data.customers || []);
      renderList();
    } catch (e) {
      toast(`Failed to load: ${e.message}`);
    }
  }

  // --- Render List ---
  function renderList() {
    const list = document.getElementById('customer-list');
    const empty = document.getElementById('empty-state');
    const stats = document.getElementById('stats-bar');

    if (customers.length === 0) {
      list.classList.add('hidden');
      empty.classList.remove('hidden');
      stats.innerHTML = '';
      return;
    }

    list.classList.remove('hidden');
    empty.classList.add('hidden');

    // Stats
    const active = customers.filter(c => c.enabled !== false).length;
    const paused = customers.length - active;
    stats.innerHTML = `
      <div class="stat-chip"><span class="dot dot-total"></span>${customers.length} total</div>
      <div class="stat-chip"><span class="dot dot-active"></span>${active} active</div>
      ${paused > 0 ? `<div class="stat-chip"><span class="dot dot-paused"></span>${paused} paused</div>` : ''}
    `;

    // Cards
    list.innerHTML = customers.map(c => {
      const name = c.name || c.channelName || c.id || 'Unnamed';
      const statusClass = c.enabled === false ? 'status-paused' : 'status-active';
      const prompt = c.systemPrompt || c.prompt || '';
      const meta = prompt ? truncate(prompt, 60) : 'No system prompt';
      const paidBadge = c.paid ? '<span class="badge badge-paid">Paid</span>' : '<span class="badge badge-free">Free</span>';

      return `
        <div class="customer-card" onclick="App.openDetail('${escId(c.id)}')">
          <div class="card-status ${statusClass}"></div>
          <div class="card-info">
            <div class="card-name">${esc(name)}</div>
            <div class="card-meta">${esc(meta)}</div>
          </div>
          <div class="card-badges">${paidBadge}</div>
          <div class="card-arrow">‚Ä∫</div>
        </div>
      `;
    }).join('');
  }

  // --- Open Detail ---
  function openDetail(id) {
    const c = customers.find(x => x.id === id);
    if (!c) return;
    currentCustomer = c;
    isNew = false;
    populateForm(c);
    document.getElementById('detail-title').textContent = c.name || c.channelName || c.id;
    showScreen('detail-screen');
  }

  // --- Show Add ---
  function showAdd() {
    currentCustomer = null;
    isNew = true;
    populateForm({});
    document.getElementById('detail-title').textContent = 'New Customer';
    showScreen('detail-screen');
  }

  // --- Populate Form ---
  function populateForm(c) {
    document.getElementById('cust-name').value = c.name || c.channelName || '';
    document.getElementById('cust-prompt').value = c.systemPrompt || c.prompt || '';
    document.getElementById('cust-tools').value = (c.tools || []).join(', ');
    document.getElementById('cust-users').value = (c.users || []).join('\n');

    // Tool deny checkboxes
    const denyList = (c.toolsDeny || []);
    document.querySelectorAll('#tool-deny-grid input[data-tool]').forEach(cb => {
      cb.checked = denyList.includes(cb.dataset.tool);
    });

    editStatus = c.enabled !== false;
    editPaid = c.paid === true;
    updateToggles();
  }

  function updateToggles() {
    document.getElementById('toggle-active').classList.toggle('active', editStatus);
    document.getElementById('toggle-paused').classList.toggle('active', !editStatus);
    document.getElementById('toggle-paid').classList.toggle('active', editPaid);
    document.getElementById('toggle-free').classList.toggle('active', !editPaid);
  }

  function setStatus(val) { editStatus = val; updateToggles(); }
  function setPaid(val) { editPaid = val; updateToggles(); }

  // --- Save ---
  async function saveCustomer() {
    const name = document.getElementById('cust-name').value.trim();
    const prompt = document.getElementById('cust-prompt').value;
    const toolsRaw = document.getElementById('cust-tools').value;
    const tools = toolsRaw ? toolsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
    const usersRaw = document.getElementById('cust-users').value;
    const users = usersRaw ? usersRaw.split('\n').map(u => u.trim()).filter(Boolean) : [];
    const toolsDeny = [];
    document.querySelectorAll('#tool-deny-grid input[data-tool]:checked').forEach(cb => {
      toolsDeny.push(cb.dataset.tool);
    });

    if (!name) {
      toast('Channel name is required');
      return;
    }

    const body = {
      name,
      channelName: name.startsWith('#') ? name : `#client-${name.toLowerCase().replace(/[^a-z0-9-]/g, '-')}`,
      systemPrompt: prompt,
      tools,
      users,
      toolsDeny,
      enabled: editStatus,
      paid: editPaid,
    };

    try {
      if (isNew) {
        await api('POST', '/api/customers', body);
        toast('Customer created ‚úì');
      } else {
        await api('PATCH', `/api/customers/${encodeURIComponent(currentCustomer.id)}`, body);
        // Handle status changes via dedicated endpoints
        if (editStatus && currentCustomer.enabled === false) {
          await api('POST', `/api/customers/${encodeURIComponent(currentCustomer.id)}/activate`);
        } else if (!editStatus && currentCustomer.enabled !== false) {
          await api('POST', `/api/customers/${encodeURIComponent(currentCustomer.id)}/pause`);
        }
        toast('Saved ‚úì');
      }
      await loadCustomers();
      showScreen('list-screen');
    } catch (e) {
      toast(`Error: ${e.message}`);
    }
  }

  // --- Delete ---
  function confirmDelete() {
    if (!currentCustomer) return;
    const name = currentCustomer.name || currentCustomer.id;
    pendingAction = async () => {
      try {
        await api('DELETE', `/api/customers/${encodeURIComponent(currentCustomer.id)}`);
        toast('Deleted ‚úì');
        await loadCustomers();
        showScreen('list-screen');
      } catch (e) {
        toast(`Error: ${e.message}`);
      }
    };
    document.getElementById('confirm-title').textContent = 'Delete Customer';
    document.getElementById('confirm-message').textContent = `Remove "${name}" and all associated config? This will restart the gateway.`;
    document.getElementById('confirm-dialog').classList.remove('hidden');
  }

  function executeConfirmed() {
    document.getElementById('confirm-dialog').classList.add('hidden');
    if (pendingAction) { pendingAction(); pendingAction = null; }
  }

  function dismissDialog() {
    document.getElementById('confirm-dialog').classList.add('hidden');
    pendingAction = null;
  }

  // --- Navigation ---
  function backToList() { showScreen('list-screen'); }
  function logout() {
    localStorage.removeItem('ca_api_url');
    localStorage.removeItem('ca_api_token');
    showScreen('auth-screen');
  }
  async function refresh() {
    await loadCustomers();
    toast('Refreshed ‚úì');
  }

  // --- Toast ---
  let toastTimer = null;
  function toast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.remove('hidden');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.add('hidden'), 2500);
  }

  // --- Helpers ---
  function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function escId(s) { return s.replace(/'/g, "\\'"); }
  function truncate(s, n) { return s.length > n ? s.slice(0, n) + '‚Ä¶' : s; }

  // --- Init ---
  function init() {
    loadAuth();
    // Auto-connect if we have saved credentials
    const savedUrl = localStorage.getItem('ca_api_url');
    const savedToken = localStorage.getItem('ca_api_token');
    if (savedUrl && savedToken) {
      apiUrl = savedUrl;
      apiToken = savedToken;
      api('GET', '/api/health')
        .then(() => { loadCustomers(); showScreen('list-screen'); })
        .catch(() => { showScreen('auth-screen'); });
    }
  }

  document.addEventListener('DOMContentLoaded', init);

  // Public API
  return {
    connect, refresh, logout,
    openDetail, showAdd, backToList,
    setStatus, setPaid,
    saveCustomer, confirmDelete, executeConfirmed, dismissDialog,
  };
})();
</script><script>
    // Demo mode: inject mock data immediately
    (function() {
      const MOCK = [
        {
          id: 'client-acme-corp',
          name: 'Acme Corp',
          channelName: '#client-acme-corp',
          systemPrompt: 'You are a helpful customer support agent for Acme Corp. Answer questions about their industrial products catalog. Be professional but friendly. Do not discuss pricing ‚Äî direct them to their sales rep.',
          tools: ['web_search', 'knowledge_base'],
          users: ['U04ACME001', 'U04ACME002', 'U04ACME003'],
          toolsDeny: ['exec', 'write', 'edit', 'gateway'],
          enabled: true,
          paid: true,
        },
        {
          id: 'client-bright-dental',
          name: 'Bright Dental',
          channelName: '#client-bright-dental',
          systemPrompt: 'You help Bright Dental staff with appointment scheduling and patient FAQ. HIPAA compliant ‚Äî never share patient data. Focus on general dental care info and scheduling.',
          tools: ['calendar', 'knowledge_base'],
          users: ['U05DENT001', 'U05DENT002'],
          toolsDeny: ['exec', 'write', 'edit'],
          enabled: true,
          paid: true,
        },
        {
          id: 'client-nova-fitness',
          name: 'Nova Fitness',
          channelName: '#client-nova-fitness',
          systemPrompt: 'You are a fitness coaching assistant for Nova Fitness members. Provide workout suggestions, nutrition tips, and class schedules. Always recommend consulting a doctor before starting new programs.',
          tools: ['web_search'],
          enabled: false,
          paid: false,
        },
        {
          id: 'client-peak-realty',
          name: 'Peak Realty',
          channelName: '#client-peak-realty',
          systemPrompt: 'Real estate assistant for Peak Realty agents. Help with property descriptions, market comps, and client communication drafts. Keep tone professional and knowledgeable.',
          tools: ['web_search', 'calculator'],
          enabled: true,
          paid: true,
        },
        {
          id: 'client-demo-sandbox',
          name: 'Demo Sandbox',
          channelName: '#client-demo-sandbox',
          systemPrompt: 'A sandbox environment for demos and testing. Respond helpfully to any query. No restrictions.',
          tools: [],
          enabled: true,
          paid: false,
        },
      ];

      // Override the App internals to use mock data
      const origInit = App.connect;

      // Patch: intercept loadCustomers-equivalent behavior
      // Since we're starting on list-screen, we just need to render
      setTimeout(() => {
        // Access internal state by re-rendering
        const list = document.getElementById('customer-list');
        const empty = document.getElementById('empty-state');
        const stats = document.getElementById('stats-bar');

        const active = MOCK.filter(c => c.enabled !== false).length;
        const paused = MOCK.length - active;

        stats.innerHTML = `
          <div class="stat-chip"><span class="dot dot-total"></span>${MOCK.length} total</div>
          <div class="stat-chip"><span class="dot dot-active"></span>${active} active</div>
          ${paused > 0 ? `<div class="stat-chip"><span class="dot dot-paused"></span>${paused} paused</div>` : ''}
        `;

        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function truncate(s, n) { return s.length > n ? s.slice(0, n) + '‚Ä¶' : s; }

        list.innerHTML = MOCK.map(c => {
          const statusClass = c.enabled === false ? 'status-paused' : 'status-active';
          const meta = c.systemPrompt ? truncate(c.systemPrompt, 60) : 'No system prompt';
          const paidBadge = c.paid ? '<span class="badge badge-paid">Paid</span>' : '<span class="badge badge-free">Free</span>';

          return `
            <div class="customer-card" onclick="DemoApp.openDetail('${c.id}')">
              <div class="card-status ${statusClass}"></div>
              <div class="card-info">
                <div class="card-name">${esc(c.name)}</div>
                <div class="card-meta">${esc(meta)}</div>
              </div>
              <div class="card-badges">${paidBadge}</div>
              <div class="card-arrow">‚Ä∫</div>
            </div>
          `;
        }).join('');

        list.classList.remove('hidden');
        empty.classList.add('hidden');

        // Demo detail navigation
        window.DemoApp = {
          openDetail(id) {
            const c = MOCK.find(x => x.id === id);
            if (!c) return;
            document.getElementById('cust-name').value = c.name || '';
            document.getElementById('cust-prompt').value = c.systemPrompt || '';
            document.getElementById('cust-tools').value = (c.tools || []).join(', ');
            document.getElementById('cust-users').value = (c.users || []).join('\n');
            const denyList = c.toolsDeny || [];
            document.querySelectorAll('#tool-deny-grid input[data-tool]').forEach(cb => {
              cb.checked = denyList.includes(cb.dataset.tool);
            });

            const isActive = c.enabled !== false;
            document.getElementById('toggle-active').classList.toggle('active', isActive);
            document.getElementById('toggle-paused').classList.toggle('active', !isActive);
            document.getElementById('toggle-paid').classList.toggle('active', c.paid);
            document.getElementById('toggle-free').classList.toggle('active', !c.paid);

            document.getElementById('detail-title').textContent = c.name;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('detail-screen').classList.add('active');
          }
        };
      }, 100);
    })();
  </script>
</body>
</html>
